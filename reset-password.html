<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Auramax</title>
  <meta name="description" content="Reset your Auramax account password.">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="auramax.png">
  <link rel="apple-touch-icon" href="auramax.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Ambient Background -->
  <div class="ambient-bg">
    <div class="ambient-orb ambient-orb-1"></div>
    <div class="ambient-orb ambient-orb-2"></div>
    <div class="ambient-orb ambient-orb-3"></div>
  </div>

  <!-- Noise Texture Overlay -->
  <div class="noise-overlay"></div>

  <!-- Navigation -->
  <nav>
    <div class="nav-pill">
      <a href="/" class="logo">
        <img src="auramax.png" alt="Auramax">
      </a>
      <a href="/" class="nav-cta">Back to Home</a>
    </div>
  </nav>

  <!-- Reset Password Section -->
  <section class="reset-section">
    <div class="container">
      <div class="reset-card">
        <div class="reset-glow"></div>

        <!-- Loading State -->
        <div id="state-loading" class="reset-state">
          <div class="reset-spinner"></div>
          <p>Verifying your reset link...</p>
        </div>

        <!-- Error State -->
        <div id="state-error" class="reset-state" style="display: none;">
          <div class="reset-icon reset-icon-error">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </div>
          <h2>Link Expired or Invalid</h2>
          <p id="error-message">This password reset link has expired or is no longer valid.</p>
          <a href="/" class="btn btn-primary">Return to Homepage</a>
          <p class="reset-hint">Need a new link? Open the AuraMax app and request another password reset.</p>
        </div>

        <!-- Form State -->
        <div id="state-form" class="reset-state" style="display: none;">
          <span class="section-label">Password Reset</span>
          <h2>Create a new <span class="gradient-text">password</span></h2>
          <p class="reset-subtitle">Enter your new password below to regain access to your account.</p>

          <form id="reset-form" class="reset-form" novalidate>
            <div class="form-group">
              <label for="password">New Password</label>
              <div class="input-wrapper">
                <input
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Enter new password"
                  autocomplete="new-password"
                  required
                  minlength="6"
                >
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <svg class="icon-show" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  <svg class="icon-hide" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="confirm-password">Confirm Password</label>
              <div class="input-wrapper">
                <input
                  type="password"
                  id="confirm-password"
                  name="confirm-password"
                  placeholder="Confirm new password"
                  autocomplete="new-password"
                  required
                  minlength="6"
                >
                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                  <svg class="icon-show" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                  <svg class="icon-hide" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                  </svg>
                </button>
              </div>
            </div>

            <div id="form-error" class="form-error" style="display: none;"></div>

            <!-- Password Strength Checklist -->
            <div class="password-checklist">
              <p class="checklist-label">Strongly recommended:</p>
              <ul>
                <li id="check-length" class="check-item">
                  <span class="check-icon"></span>
                  At least 8 characters
                </li>
                <li id="check-uppercase" class="check-item">
                  <span class="check-icon"></span>
                  Uppercase letter
                </li>
                <li id="check-lowercase" class="check-item">
                  <span class="check-icon"></span>
                  Lowercase letter
                </li>
                <li id="check-number" class="check-item">
                  <span class="check-icon"></span>
                  Number
                </li>
                <li id="check-symbol" class="check-item">
                  <span class="check-icon"></span>
                  Symbol (!@#$%...)
                </li>
              </ul>
            </div>

            <button type="submit" id="submit-btn" class="btn btn-primary btn-large btn-full">
              <span class="btn-text">Update Password</span>
              <span class="btn-spinner" style="display: none;"></span>
            </button>
          </form>
        </div>

        <!-- Success State -->
        <div id="state-success" class="reset-state" style="display: none;">
          <div class="reset-icon reset-icon-success">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9 12l2 2 4-4"/>
            </svg>
          </div>
          <h2>Password Updated</h2>
          <p>Your password has been successfully changed. You can now return to the AuraMax app and sign in with your new password.</p>
          <a href="/" class="btn btn-primary">Return to Homepage</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <a href="/" class="footer-logo">
          <img src="auramax.png" alt="Auramax">
        </a>
        <ul class="footer-links">
          <li><a href="privacy.html">Privacy</a></li>
          <li><a href="terms.html">Terms</a></li>
          <li><a href="mailto:jasprcodes@gmail.com">Contact</a></li>
        </ul>
        <span class="copyright">Â© 2026 Auramax</span>
      </div>
    </div>
  </footer>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://sowxwoadsozyrscbwckg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNvd3h3b2Fkc296eXJzY2J3Y2tnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4Mzc4MjksImV4cCI6MjA4MjQxMzgyOX0.1H25O0pxu9Dyeq8E8ZNQJ8agXLOYCCx3QICoDUaavIo';

    // State elements
    const stateLoading = document.getElementById('state-loading');
    const stateError = document.getElementById('state-error');
    const stateForm = document.getElementById('state-form');
    const stateSuccess = document.getElementById('state-success');
    const errorMessage = document.getElementById('error-message');

    // Form elements
    const form = document.getElementById('reset-form');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirm-password');
    const submitBtn = document.getElementById('submit-btn');
    const formError = document.getElementById('form-error');

    // Checklist elements
    const checkLength = document.getElementById('check-length');
    const checkUppercase = document.getElementById('check-uppercase');
    const checkLowercase = document.getElementById('check-lowercase');
    const checkNumber = document.getElementById('check-number');
    const checkSymbol = document.getElementById('check-symbol');

    let supabase = null;
    let isSubmitting = false;

    // Parse URL query parameters
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        token_hash: params.get('token_hash'),
        type: params.get('type'),
        error: params.get('error'),
        error_description: params.get('error_description')
      };
    }

    // Clear URL params for security (without reload)
    function clearUrlParams() {
      if (window.history.replaceState) {
        window.history.replaceState(null, '', window.location.pathname);
      }
    }

    // Show a specific state
    function showState(state) {
      stateLoading.style.display = 'none';
      stateError.style.display = 'none';
      stateForm.style.display = 'none';
      stateSuccess.style.display = 'none';
      state.style.display = 'block';
    }

    // Show error with message
    function showError(message) {
      errorMessage.textContent = message;
      showState(stateError);
    }

    // Initialize Supabase and verify recovery token
    async function init() {
      const params = getQueryParams();

      // Check for error in URL
      if (params.error) {
        const errorDesc = params.error_description || 'This link is invalid or has expired.';
        showError(errorDesc.replace(/\+/g, ' '));
        clearUrlParams();
        return;
      }

      // Check for required token_hash - show error immediately if missing
      if (!params.token_hash) {
        showError('Invalid reset link. Please request a new password reset email from the app.');
        return;
      }

      // Check if type is recovery
      if (params.type && params.type !== 'recovery') {
        showError('This link is not a password reset link. Please request a password reset from the app.');
        clearUrlParams();
        return;
      }

      // Initialize Supabase client
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      try {
        // Verify the OTP token_hash
        const { data, error: verifyError } = await supabase.auth.verifyOtp({
          type: 'recovery',
          token_hash: params.token_hash
        });

        // Clear URL params after verification attempt
        clearUrlParams();

        if (verifyError) {
          showError('This reset link is invalid or has expired. Please request a new password reset email.');
          return;
        }

        // Verify we have a session
        if (!data || !data.session) {
          showError('Unable to verify reset link. Please request a new password reset email.');
          return;
        }

        // Show the form
        showState(stateForm);
        passwordInput.focus();

      } catch (err) {
        clearUrlParams();
        showError('Something went wrong. Please try again or request a new reset link.');
      }
    }

    // Password validation
    function validatePassword(password) {
      const checks = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        symbol: /[!@#$%^&*(),.?":{}|<>_\-+=\[\]\\;'`~]/.test(password)
      };

      // Update checklist UI
      checkLength.classList.toggle('check-pass', checks.length);
      checkUppercase.classList.toggle('check-pass', checks.uppercase);
      checkLowercase.classList.toggle('check-pass', checks.lowercase);
      checkNumber.classList.toggle('check-pass', checks.number);
      checkSymbol.classList.toggle('check-pass', checks.symbol);

      return checks;
    }

    // Show form error
    function showFormError(message) {
      formError.textContent = message;
      formError.style.display = 'block';
    }

    // Hide form error
    function hideFormError() {
      formError.style.display = 'none';
    }

    // Set loading state on button
    function setLoading(loading) {
      isSubmitting = loading;
      submitBtn.disabled = loading;
      submitBtn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
      submitBtn.querySelector('.btn-spinner').style.display = loading ? 'inline-block' : 'none';
    }

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();

      if (isSubmitting) return;

      hideFormError();

      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;

      // Validate minimum length (required)
      if (password.length < 6) {
        showFormError('Password must be at least 6 characters long.');
        passwordInput.focus();
        return;
      }

      // Validate passwords match
      if (password !== confirmPassword) {
        showFormError('Passwords do not match.');
        confirmInput.focus();
        return;
      }

      setLoading(true);

      try {
        const { error } = await supabase.auth.updateUser({
          password: password
        });

        if (error) {
          if (error.message.includes('same as')) {
            showFormError('New password must be different from your current password.');
          } else {
            showFormError(error.message || 'Failed to update password. Please try again.');
          }
          setLoading(false);
          return;
        }

        // Sign out after successful password change
        await supabase.auth.signOut();

        // Show success state
        showState(stateSuccess);

      } catch (err) {
        showFormError('Something went wrong. Please try again.');
        setLoading(false);
      }
    }

    // Toggle password visibility
    function setupPasswordToggles() {
      document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', () => {
          const input = btn.parentElement.querySelector('input');
          const showIcon = btn.querySelector('.icon-show');
          const hideIcon = btn.querySelector('.icon-hide');

          if (input.type === 'password') {
            input.type = 'text';
            showIcon.style.display = 'none';
            hideIcon.style.display = 'block';
          } else {
            input.type = 'password';
            showIcon.style.display = 'block';
            hideIcon.style.display = 'none';
          }
        });
      });
    }

    // Event listeners
    passwordInput.addEventListener('input', () => {
      validatePassword(passwordInput.value);
      hideFormError();
    });

    confirmInput.addEventListener('input', hideFormError);

    form.addEventListener('submit', handleSubmit);

    // Initialize
    setupPasswordToggles();
    init();

    // Parallax effect on ambient orbs
    let mouseX = 0, mouseY = 0;
    document.addEventListener('mousemove', (e) => {
      mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
      mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
    });

    function animateOrbs() {
      const orbs = document.querySelectorAll('.ambient-orb');
      orbs.forEach((orb, i) => {
        const speed = (i + 1) * 15;
        const x = mouseX * speed;
        const y = mouseY * speed;
        orb.style.transform = `translate(${x}px, ${y}px)`;
      });
      requestAnimationFrame(animateOrbs);
    }
    animateOrbs();
  </script>
</body>
</html>
